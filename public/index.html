<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¤ãƒƒãƒ„ã‚£ãƒ¼</title>
<style>
body{
  font-family:sans-serif;
  background:#f5f5f5;
}
table{border-collapse:collapse}
th,td{border:1px solid #333;padding:6px;text-align:center;min-width:70px}
.used{background:#9be79b}
.subtotal{background:#fff7b2}
.total{background:#ddd;font-weight:bold}
.preview{color:#888}

#statusBox{
  padding:10px;
  border:1px solid #333;
  margin:10px 0;
  background:#f7f7f7;
}

#dice{
  display:flex;
  gap:10px;
  margin-top:10px;
}

/* ===== DOZæš—è»¢ï¼ˆå®Œå…¨é»’ï¼‰ ===== */
#dozOverlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  z-index:10000;
}
#dozOverlay .dozText{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  color:#fff;
  font-size:28px;
  letter-spacing:3px;
  opacity:0.2;
  user-select:none;
  pointer-events:none;
  text-shadow: 0 0 12px rgba(255,255,255,0.25);
}
@keyframes heartBlink{
  0%   { opacity:0.08; transform:translate(-50%,-50%) scale(0.98); }
  12%  { opacity:0.95; transform:translate(-50%,-50%) scale(1.02); }
  24%  { opacity:0.12; transform:translate(-50%,-50%) scale(0.99); }
  55%  { opacity:0.12; transform:translate(-50%,-50%) scale(0.99); }
  67%  { opacity:0.85; transform:translate(-50%,-50%) scale(1.02); }
  79%  { opacity:0.10; transform:translate(-50%,-50%) scale(0.99); }
  100% { opacity:0.08; transform:translate(-50%,-50%) scale(0.98); }
}
#dozOverlay.blink .dozText{
  animation: heartBlink 1.1s infinite;
}

/* ===== ãƒ€ã‚¤ã‚¹è¦‹ãŸç›® ===== */
.die{
  display:flex;
  justify-content:center;
  align-items:center;
  width:64px;
  height:64px;
  border-radius:12px;
  background:#ffffff;
  border:2px solid #222;
  cursor:pointer;
  transition:transform 0.1s ease;
}
.die:hover{ transform:scale(1.05); }
.held{
  background:#ffb3b3;
  border-color:#c00;
}
.die img{
  width:46px;
  height:46px;
  object-fit:contain;
  pointer-events:none;
  filter: drop-shadow(0 2px 4px rgba(0,0,0,0.4));
}

/* ===== ãƒ­ãƒ¼ãƒ«ç”¨ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆå®Œå…¨é»’ï¼‰ ===== */
#rollOverlay{
  position:fixed;
  inset:0;
  background:#000;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:9999;
  cursor:grab;
}
#rollOverlay:active{ cursor:grabbing; }
#rollBox{
  width:min(700px, 92vw);
  height:min(420px, 70vh);
  position:relative;
}
#threeCanvas{
  width:100%;
  height:100%;
  display:block;
  border-radius:12px;
  background:#000;
}
#rollHint{
  position:absolute;
  bottom:10px;
  left:50%;
  transform:translateX(-50%);
  color:#fff;
  font-size:14px;
  opacity:0.75;
  user-select:none;
  pointer-events:none;
}

/* ===== ã‚¤ã‚«ã‚µãƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ—ï¼ˆé™ã‹ï¼‰ ===== */
#cheatOverlay{
  position:fixed;
  inset:0;
  display:none;
  justify-content:center;
  align-items:center;
  z-index:30000;
  background:rgba(0,0,0,0.0);
}
#cheatPopup{
  width:min(360px, 92vw);
  background:#fff;
  border:2px solid #222;
  border-radius:12px;
  padding:14px;
  box-shadow:0 10px 30px rgba(0,0,0,0.35);
}
#cheatTitle{
  font-weight:700;
  margin-bottom:6px;
}
#cheatNow{
  font-size:14px;
  opacity:0.8;
  margin-bottom:10px;
}
#cheatBtns{
  display:grid;
  grid-template-columns:repeat(3, 1fr);
  gap:8px;
}
#cheatBtns button{
  padding:10px 8px;
  border-radius:10px;
  border:1px solid #333;
  background:#f3f3f3;
  cursor:pointer;
}
#cheatBtns button:hover{
  background:#e9e9e9;
}
</style>
</head>

<body>

<h1>ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒ¤ãƒƒãƒ„ã‚£ãƒ¼</h1>

<div id="statusBox">
  <div id="turn"></div>
  <div id="rollInfo"></div>
  <div id="gameStatus"></div>
</div>

<button id="rollBtn" onclick="openRollOverlay()">ğŸ² æŒ¯ã‚‹</button>
<button id="dozBtn" onclick="doubleOrZero()" style="margin-left:6px; display:none;">ğŸ’€ ãƒ€ãƒ–ãƒ«ãƒ»ã‚ªã‚¢ãƒ»ã‚¼ãƒ­</button>
<button id="reYaBtn" onclick="godReYahtzee()" style="margin-left:6px; display:none;">âš¡ å†ãƒ¤ãƒƒãƒ„ã‚£ãƒ¼æŒ‘æˆ¦</button>
<button id="reportBtn" onclick="startReport()" style="margin-left:6px;">ğŸš¨ é€šå ±</button>

<div style="display:flex;">
  <div id="dice"></div>
</div>

<h2>å…¨å“¡ã‚¹ã‚³ã‚¢è¡¨</h2>
<div id="board"></div>
<div id="msg"></div>

<!-- ãƒ­ãƒ¼ãƒ«ç”¨3Dãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="rollOverlay">
  <div id="rollBox">
    <canvas id="threeCanvas"></canvas>
    <div id="rollHint">ãƒ€ã‚¤ã‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æŒ¯ã‚Œ â†’ é›¢ã™ã¨ç¢ºå®š</div>
  </div>
</div>

<!-- DOZæš—è»¢ -->
<div id="dozOverlay">
  <div class="dozText">é‹å‘½ã‚’å¾…ã¦â€¦</div>
</div>

<!-- ã‚¤ã‚«ã‚µãƒãƒãƒƒãƒ—ã‚¢ãƒƒãƒ— -->
<div id="cheatOverlay">
  <div id="cheatPopup">
    <div id="cheatTitle"></div>
    <div id="cheatNow"></div>

    <div id="cheatBtns">
      <button data-d="-10">-10</button>
      <button data-d="-5">-5</button>
      <button data-d="-1">-1</button>
      <button data-d="1">+1</button>
      <button data-d="5">+5</button>
      <button data-d="10">+10</button>
    </div>

    <div style="margin-top:10px;">
      <button id="cheatCancelBtn">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
      <button id="cheatOkBtn" style="margin-left:8px;">ç¢ºå®š</button>
    </div>
  </div>
</div>

<script src="/socket.io/socket.io.js"></script>
<script type="module" src="threeRoll.js"></script>

<script>
/* =========================
   Socket / åŸºæœ¬çŠ¶æ…‹
========================= */
const socket = io();
let myId = null;
let reportActive = false;
let reportReporterId = null;

socket.on("disconnect", (reason) => {
  console.log("[socket] disconnected:", reason);
});
socket.on("reconnect", (n) => {
  console.log("[socket] reconnected:", n);
});

/* =========================
   åŠ¹æœéŸ³ï¼ˆå…ˆã«ç”¨æ„ï¼šsfxãŒæ¥ã¦ã‚‚æ­»ãªãªã„ï¼‰
========================= */
const sounds = {
  roll: new Audio("roll.mp3"),
  god: new Audio("god.mp3"),
  doz: new Audio("doz.mp3"),
  heart: new Audio("heartbeat.mp3"),
  siren: new Audio("siren.mp3"),
  correct: new Audio("correct.mp3"),
  wrong: new Audio("wrong.mp3"),
  fanfare:new Audio("fanfare.mp3"),
};
function playSound(name){
  const a=sounds[name];
  if(!a) return;
  a.currentTime=0;
  a.play().catch(()=>{});
}
function startHeart(){
  const h=sounds.heart;
  if(!h) return;
  h.loop=true;
  h.currentTime=0;
  h.play().catch(()=>{});
}
function stopHeart(){
  const h=sounds.heart;
  if(!h) return;
  h.pause();
  h.currentTime=0;
}

/* =========================
   threeRoll.js é€£æº
========================= */
window.socket = socket;
window.playSound = playSound;
window.closeRollOverlay = closeRollOverlay;

/* =========================
   æš—è»¢ãƒ»éŸ³ã®å…¨å“¡åŒæœŸï¼ˆå—ä¿¡ï¼‰
========================= */

// â˜… ã‚µãƒ¼ãƒã‹ã‚‰ã®åŠ¹æœéŸ³åŒæœŸï¼ˆå…¨å“¡é³´ã‚‹ï¼‰
socket.on("sfx", (p) => {
  if(!p || !p.name) return;
  if(p.name === "heartStart"){ startHeart(); return; }
  if(p.name === "heartStop"){  stopHeart();  return; }
  playSound(p.name);
});

// â˜… ãƒ­ãƒ¼ãƒ«æš—è»¢ï¼ˆå…¨å“¡åŒæœŸï¼‰
socket.on("rollOverlay", (p) => {
  const ov = document.getElementById("rollOverlay");
  const hint = document.getElementById("rollHint");

  if(p?.show){
    ov.style.display = "flex";
    const isMe = (p.bySocketId === myId);

    if(isMe){
      hint.innerText = "ãƒ€ã‚¤ã‚¹ã‚’ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦æŒ¯ã‚Œ â†’ é›¢ã™ã¨ç¢ºå®š";
      if(window.start3DRoll) window.start3DRoll();
    }else{
      hint.innerText = (p.byName || "èª°ã‹") + " ãŒãƒ­ãƒ¼ãƒ«ä¸­â€¦";
      if(window.stop3DRoll) window.stop3DRoll();
    }
  }else{
    ov.style.display = "none";
    if(window.stop3DRoll) window.stop3DRoll();
  }
});

// â˜… DOZæš—è»¢ï¼ˆå…¨å“¡åŒæœŸï¼‰
let dozPending = false;
let dozOwner = false;

socket.on("dozOverlay", (p) => {
  console.log("[dozOverlay]", p);
  const ov = document.getElementById("dozOverlay");
  const btn = document.getElementById("dozBtn");

  if(p?.show){
    ov.style.display="block";
    ov.classList.add("blink");
  }else{
    ov.classList.remove("blink");
    ov.style.display="none";

    // æŠ¼ã—ãŸæœ¬äººã ã‘UIæˆ»ã™ï¼ˆdozPendingã¯è§¦ã‚‰ãªã„ï¼‰
    if(dozOwner){
      btn.disabled = false;
      btn.innerText = btn.dataset.prevText || "ğŸ’€ ãƒ€ãƒ–ãƒ«ãƒ»ã‚ªã‚¢ãƒ»ã‚¼ãƒ­";
      dozOwner = false;
    }
  }
});

/* =========================
   SocketåŸºæœ¬ã‚¤ãƒ™ãƒ³ãƒˆ
========================= */
socket.on("connect",()=>{ myId = socket.id; });
socket.on("full",()=>{ document.getElementById("msg").innerText="æº€å“¡ã§ã™ï¼ˆ4äººã¾ã§ï¼‰"; });
socket.on("update",(game)=>{
  // DOZãƒ­ãƒƒã‚¯åŒæœŸï¼ˆã‚ãªãŸãŒæ—¢ã«å…¥ã‚Œã¦ã‚‹ãªã‚‰ãã®ã¾ã¾ï¼‰
  dozPending = !!game.turnFlags?.dozInProgress;

  reportActive = !!game.report?.active;
  reportReporterId = game.report?.reporterSocketId || null;

  render(game);
});

/* =========================
   ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ï¼ˆ3Dãƒ­ãƒ¼ãƒ«ï¼‰
========================= */
function openRollOverlay(){
  // è¡¨ç¤ºè‡ªä½“ã¯ã‚µãƒ¼ãƒã‹ã‚‰ã®rollOverlayã§åŒæœŸã—ã¦è¡Œã†
  socket.emit("rollOverlayOpen");
}
function closeRollOverlay(){
  document.getElementById("rollOverlay").style.display="none";
  if(window.stop3DRoll) window.stop3DRoll();
  socket.emit("rollOverlayClose");
}

/* =========================
   æ—¢å­˜æ“ä½œ
========================= */
function hold(i){
  if(dozPending || reportActive) return;
  socket.emit("toggleHold", i);
}
function score(cat){
  if(dozPending || reportActive) return;
  socket.emit("score", cat);
}

function doubleOrZero(){
  if(dozPending) return;

  const btn = document.getElementById("dozBtn");
  dozPending = true;
  dozOwner = true;
  btn.disabled = true;

  const prevText = btn.innerText;
  btn.dataset.prevText = prevText;
  btn.innerText = "ğŸ«€ é‹å‘½ã‚’å¾…ã¦â€¦";

  // â˜…æš—è»¢é–‹å§‹ã ã‘ï¼ˆçµæœãƒ­ãƒ¼ãƒ«ã¯ã‚µãƒ¼ãƒãŒ2.5ç§’å¾Œã«å®Ÿè¡Œï¼‰
  socket.emit("dozOverlayStart");
}

function godReYahtzee(){
  if(dozPending) return;
  socket.emit("godReYahtzee");
}

/* =========================
   ç”»åƒãƒ‘ã‚¹
========================= */
function diceImgSrc(n){
  return "dice-" + n + ".png";
}

/* =========================
   ã‚¹ã‚³ã‚¢ãƒ—ãƒ¬ãƒ“ãƒ¥ãƒ¼
========================= */
function calcPreview(cat,dice,hanModeTurn){
  const counts=[0,0,0,0,0,0];
  dice.forEach(d=>counts[d-1]++);
  const sum=dice.reduce((a,b)=>a+b,0);

  switch(cat){
    case "ones":return counts[0]*1;
    case "twos":return counts[1]*2;
    case "threes":return counts[2]*3;
    case "fours":return counts[3]*4;
    case "fives":return counts[4]*5;
    case "sixes":return counts[5]*6;
    case "threeKind":return counts.some(c=>c>=3)?sum:0;
    case "fourKind":return counts.some(c=>c>=4)?sum:0;
    case "fullHouse":return (counts.includes(3)&&counts.includes(2))?sum:0;
    case "smallStraight":{
      const u=[...new Set(dice)].sort().join("");
      return (u.includes("1234")||u.includes("2345")||u.includes("3456"))?30:0;
    }
    case "largeStraight":{
      const u=[...new Set(dice)].sort().join("");
      return (u==="12345"||u==="23456")?40:0;
    }
    case "chance":return sum;
    case "yahtzee":{
      const isY = counts.includes(5);
      if(!isY) return 0;
      return hanModeTurn ? 100 : 50;
    }
  }
}
function isYahtzeeDice(dice){
  return dice.every(d=>d===dice[0]);
}

/* =========================
   ã‚¤ã‚«ã‚µãƒ
========================= */
let cheatTargetCat=null;
let cheatBaseValue=0;
let cheatDelta=0;

const CAT_LABEL = {
  ones:"1", twos:"2", threes:"3", fours:"4", fives:"5", sixes:"6",
  threeKind:"3ã‚«ãƒ¼ãƒ‰", fourKind:"4ã‚«ãƒ¼ãƒ‰", fullHouse:"ãƒ•ãƒ«ãƒã‚¦ã‚¹",
  smallStraight:"Sã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ", largeStraight:"Lã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ",
  chance:"ãƒãƒ£ãƒ³ã‚¹", yahtzee:"ãƒ¤ãƒƒãƒ„ã‚£ãƒ¼"
};

function openCheat(cat, currentValue){
  cheatTargetCat = cat;
  cheatBaseValue = Number(currentValue ?? 0);
  cheatDelta = 0;

  document.getElementById("cheatTitle").innerText =
    "ã‚¤ã‚«ã‚µãƒï¼š" + (CAT_LABEL[cat] || cat);

  document.getElementById("cheatNow").innerText =
    `ç¾åœ¨: ${cheatBaseValue} â†’ å¤‰æ›´å¾Œ: ${cheatBaseValue}`;

  document.getElementById("cheatOverlay").style.display = "flex";
}

function cheatStep(d){
  cheatDelta += d;
  document.getElementById("cheatNow").innerText =
    `ç¾åœ¨: ${cheatBaseValue} â†’ å¤‰æ›´å¾Œ: ${cheatBaseValue + cheatDelta}`;
}

function cheatClose(){
  cheatTargetCat=null;
  cheatBaseValue=0;
  cheatDelta=0;
  document.getElementById("cheatOverlay").style.display="none";
}

function cheatConfirm(){
  if(!cheatTargetCat){
    cheatClose();
    return;
  }
  const newValue = Math.max(0, Math.trunc(cheatBaseValue + cheatDelta));

  if(newValue === cheatBaseValue){
    cheatClose();
    return;
  }

  socket.emit("cheatSet", { cat: cheatTargetCat, value: newValue });
  cheatClose();
}

// â˜… ã‚¤ã‚«ã‚µãƒãƒœã‚¿ãƒ³ï¼šå§”è­²ã§1å›ã ã‘
(function bindCheatOnce(){
  const box = document.getElementById("cheatBtns");
  box.addEventListener("click",(e)=>{
    const btn = e.target.closest("button[data-d]");
    if(!btn) return;
    e.preventDefault();
    cheatStep(Number(btn.dataset.d));
  });

  document.getElementById("cheatCancelBtn").addEventListener("click",(e)=>{
    e.preventDefault();
    cheatClose();
  });
  document.getElementById("cheatOkBtn").addEventListener("click",(e)=>{
    e.preventDefault();
    cheatConfirm();
  });

  document.getElementById("cheatOverlay").addEventListener("click",(e)=>{
    if(e.target.id==="cheatOverlay") cheatClose();
  });
})();

/* =========================
   é€šå ±
========================= */
function startReport(){
  const rollVisible = document.getElementById("rollOverlay").style.display === "flex";
  const dozVisible  = document.getElementById("dozOverlay").style.display === "block";
  if(rollVisible || dozVisible || dozPending || reportActive) return;

  socket.emit("reportStart");
}



/* =========================
   render
========================= */
let wasHanArmed=false;
let wasHanFull=false;

function render(game){
  const rollBtn=document.getElementById("rollBtn");
  const dozBtn=document.getElementById("dozBtn");
  const reYaBtn=document.getElementById("reYaBtn");

  const currentPlayer=game.players[game.turn];
  const isMyTurn=currentPlayer && currentPlayer.socketId===myId;
ã€€const reportLock = reportActive; // å…¨å“¡ãƒ­ãƒƒã‚¯
ã€€const iAmReporter = reportLock && (reportReporterId === myId);
ã€€
ã€€const reportBtn = document.getElementById("reportBtn");
const inOverlay = (document.getElementById("rollOverlay").style.display === "flex")
               || (document.getElementById("dozOverlay").style.display === "block");

reportBtn.disabled = game.gameOver || dozPending || inOverlay || reportLock;

  document.getElementById("turn").innerText = "ç¾åœ¨ã®ã‚¿ãƒ¼ãƒ³: " + (currentPlayer ? currentPlayer.name : "");
  document.getElementById("rollInfo").innerText = "æ®‹ã‚Šãƒ­ãƒ¼ãƒ«: " + (3 - game.rollCount);

  const status=document.getElementById("gameStatus");
  if(game.gameOver){
    status.innerText="ã‚²ãƒ¼ãƒ çµ‚äº†ï¼ å‹è€…: " + (game.winnerName || "");
  }else{
    if(game.turnFlags?.hanModeTurn){
      status.innerText=(isMyTurn?"ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™":"ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“")+" / ğŸ”¥ æ¼¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆå®Œå…¨ï¼‰";
    }else if(game.turnFlags?.hanModeArmed){
      status.innerText=(isMyTurn?"ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™":"ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“")+" / ğŸ”¥ æ¼¢ãƒ¢ãƒ¼ãƒ‰ï¼ˆç‚¹ç¯ï¼‰";
    }else{
      status.innerText=isMyTurn ? "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã™" : "ã‚ãªãŸã®ã‚¿ãƒ¼ãƒ³ã§ã¯ã‚ã‚Šã¾ã›ã‚“";
    }
  }

if(reportActive){
  if(reportReporterId === myId){
    status.innerText = "ğŸš¨ é€šå ±ä¸­ï¼šä¸æ­£ã ã¨æ€ã†å¾—ç‚¹ãƒã‚¹ã‚’é¸æŠã—ã¦ãã ã•ã„";
  }else{
    status.innerText = "ğŸš¨ é€šå ±åˆ¤å®šä¸­â€¦";
  }
}

  // æ¼¢ãƒ¢ãƒ¼ãƒ‰SEï¼ˆã“ã‚Œã¯ãƒ­ãƒ¼ã‚«ãƒ«ã§OKï¼‰
  const armedNow=!!game.turnFlags?.hanModeArmed;
  const fullNow=!!game.turnFlags?.hanModeTurn;
  if(isMyTurn){
    if(armedNow && !wasHanArmed) playSound("god");
    if(fullNow && !wasHanFull) playSound("god");
  }
  wasHanArmed=armedNow;
  wasHanFull=fullNow;

  // ãƒœã‚¿ãƒ³åˆ¶å¾¡
  rollBtn.disabled = dozPending || reportLock || game.gameOver || !isMyTurn || game.rollCount>=3;

  const canDoz = !game.gameOver && isMyTurn && game.rollCount===3 &&
                 !game.turnFlags?.doubleOrZeroUsed &&
                 !game.turnFlags?.hanModeTurn;
  dozBtn.style.display = canDoz ? "inline-block" : "none";
  dozBtn.disabled = dozPending || reportLock || !canDoz;

  const canReYa = !game.gameOver && isMyTurn && game.rollCount===3 &&
                  game.turnFlags?.hanModeTurn &&
                  isYahtzeeDice(game.dice);
  reYaBtn.style.display = canReYa ? "inline-block" : "none";
  reYaBtn.disabled = dozPending || reportLock || !canReYa;

  // ãƒ€ã‚¤ã‚¹è¡¨ç¤ºï¼ˆç”»åƒï¼‰
  const diceDiv=document.getElementById("dice");
  diceDiv.innerHTML="";
  game.dice.forEach((d,i)=>{
    const div=document.createElement("div");
    div.className="die"+(game.held[i]?" held":"");
    div.innerHTML = `<img src="${diceImgSrc(d)}" alt="${d}">`;

    const img = div.querySelector("img");
    img.onerror = () => { div.innerText = String(d); };

    if(!dozPending && !game.gameOver && isMyTurn){
      div.onclick=()=>hold(i);
    }else{
      div.style.cursor="default";
    }
    diceDiv.appendChild(div);
  });

  // ã‚¹ã‚³ã‚¢è¡¨
  let html="<table><tr><th>é …ç›®</th>";
  game.players.forEach(p=>html+="<th>"+p.name+"</th>");
  html+="</tr>";

  const upper=[
    ["ones","1"],["twos","2"],["threes","3"],
    ["fours","4"],["fives","5"],["sixes","6"]
  ];

  function renderRow(k,label){
    html += "<tr><td>"+label+"</td>";

    game.players.forEach(p=>{
      const used = p.scores[k] !== undefined;

      // ä½¿ç”¨æ¸ˆã¿
if(used){
  const v = p.scores[k];

  // â˜…å…¨å“¡ï¼šé€šå ±ç”¨ã®æƒ…å ±ã‚’åŸ‹ã‚è¾¼ã‚€
  const base = `data-used="1" data-cat="${k}" data-pid="${p.socketId}" data-val="${v}"`;

  if(p.socketId === myId){
    // è‡ªåˆ†ã®ãƒã‚¹ï¼ˆã‚¤ã‚«ã‚µãƒå…¥å£ã‚‚æ®‹ã™ï¼‰
    html += `<td class="used" ${base} data-cheat="1">${v}</td>`;
  }else{
    html += `<td class="used" ${base}>${v}</td>`;
  }

  return;
}

      if(!dozPending && !game.gameOver && isMyTurn && p.socketId===myId && game.rollCount>0){
        const preview = calcPreview(k, game.dice, game.turnFlags?.hanModeTurn);
        html += `<td class="preview" data-score="1" data-cat="${k}">${preview}</td>`;
        return;
      }

      html += "<td></td>";
    });

    html += "</tr>";
  }

  upper.forEach(([k,l])=>renderRow(k,l));

  html += "<tr class='subtotal'><td>ä¸Šæ®µå°è¨ˆ</td>";
  game.players.forEach(p=>html+="<td>"+p.upperSubtotal+"/63</td>");
  html += "</tr>";

  html += "<tr class='subtotal'><td>ãƒœãƒ¼ãƒŠã‚¹</td>";
  game.players.forEach(p=>html+="<td>"+p.bonus+"</td>");
  html += "</tr>";

  const lower=[
    ["threeKind","3ã‚«ãƒ¼ãƒ‰"],
    ["fourKind","4ã‚«ãƒ¼ãƒ‰"],
    ["fullHouse","ãƒ•ãƒ«ãƒã‚¦ã‚¹"],
    ["smallStraight","Sã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ"],
    ["largeStraight","Lã‚¹ãƒˆãƒ¬ãƒ¼ãƒˆ"],
    ["chance","ãƒãƒ£ãƒ³ã‚¹"],
    ["yahtzee","ãƒ¤ãƒƒãƒ„ã‚£ãƒ¼"]
  ];
  lower.forEach(([k,l])=>renderRow(k,l));

  html += "<tr class='total'><td>åˆè¨ˆ</td>";
  game.players.forEach(p=>html+="<td>"+p.total+"</td>");
  html += "</tr>";

  html += "</table>";
  const board = document.getElementById("board");
  board.innerHTML = html;

  if(board.dataset.bound !== "1"){
    board.dataset.bound = "1";
    board.addEventListener("click",(e)=>{

  // =========================
  // ğŸš¨ é€šå ±ä¸­ã®å‡¦ç†ï¼ˆæœ€å„ªå…ˆï¼‰
  // =========================
  if(reportActive){

    // é€šå ±è€…ä»¥å¤–ã¯ä½•ã‚‚ã§ããªã„
    if(reportReporterId !== myId) return;

    // ä½¿ç”¨æ¸ˆã¿ãƒã‚¹ã®ã¿é¸æŠå¯èƒ½
    const tdUsed = e.target.closest("td[data-used='1']");
    if(!tdUsed) return;

    const cat = tdUsed.dataset.cat;
    const pid = tdUsed.dataset.pid;

    socket.emit("reportSelect", {
      targetSocketId: pid,
      cat: cat
    });

    return;
  }

  // =========================
  // é€šå¸¸å‡¦ç†
  // =========================

  // æœªä½¿ç”¨ãƒã‚¹ç¢ºå®š
  const tdScore = e.target.closest("td[data-score='1']");
  if(tdScore){
    if(dozPending) return;
    const cat = tdScore.dataset.cat;
    score(cat);
    return;
  }

  // ä½¿ç”¨æ¸ˆã¿ãƒã‚¹ï¼ˆã‚¤ã‚«ã‚µãƒï¼‰
  const tdCheat = e.target.closest("td[data-cheat='1']");
  if(tdCheat){
    const cat = tdCheat.dataset.cat;
    const val = Number(tdCheat.dataset.val);
    openCheat(cat, val);
    return;
  }
});
  }
}

// ===== ä¾‹å¤–ç›£è¦–ï¼ˆåŸå› èª¿æŸ»ç”¨ï¼‰=====
;(() => {
  try {
    window.addEventListener("error", (e) => {
      console.log("JS ERROR:", e.message, e.filename, e.lineno, e.colno);
    });
    window.addEventListener("unhandledrejection", (e) => {
      console.log("PROMISE ERROR:", e.reason);
    });
    console.log("[debug] error handlers ready");
  } catch (err) {
    console.log("debug handler install failed:", err);
  }
})();

</script>

</body>
</html>